{
    "sourceFile": "src/pages/files.astro",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764348296936,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764348296936,
            "name": "Commit-0",
            "content": "---\nimport Layout from '../layouts/Layout.astro';\n\n// Get the assets prefix from environment\nconst assetsPrefix = Astro.locals.runtime?.env?.ASSETS_PREFIX || '/app';\n---\n\n<Layout title=\"File Uploader\">\n\t<div class=\"container mx-auto p-6 max-w-6xl\">\n\t\t<h1 class=\"text-4xl font-bold text-center mb-8\">File Uploader</h1>\n\t\t\n\t\t<!-- Upload Section -->\n\t\t<div class=\"card bg-base-100 shadow-xl mb-8\">\n\t\t\t<div class=\"card-body\">\n\t\t\t\t<h2 class=\"card-title text-2xl mb-4\">Upload Files</h2>\n\t\t\t\t<form id=\"uploadForm\" class=\"space-y-4\">\n\t\t\t\t\t<div class=\"form-control\">\n\t\t\t\t\t\t<label class=\"label\">\n\t\t\t\t\t\t\t<span class=\"label-text\">Select Files</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input \n\t\t\t\t\t\t\ttype=\"file\" \n\t\t\t\t\t\t\tid=\"fileInput\" \n\t\t\t\t\t\t\tmultiple \n\t\t\t\t\t\t\tclass=\"file-input file-input-bordered w-full\" \n\t\t\t\t\t\t\taccept=\"image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class=\"form-control\">\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn btn-primary\" id=\"uploadBtn\">\n\t\t\t\t\t\t\t<span class=\"loading loading-spinner loading-sm hidden\" id=\"uploadSpinner\"></span>\n\t\t\t\t\t\t\tUpload Files\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t\t\n\t\t\t\t<!-- Upload Progress -->\n\t\t\t\t<div id=\"uploadProgress\" class=\"hidden mt-4\">\n\t\t\t\t\t<div class=\"progress progress-primary w-full\">\n\t\t\t\t\t\t<div class=\"progress-bar\" id=\"progressBar\" style=\"width: 0%\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p class=\"text-sm mt-2\" id=\"progressText\">Uploading...</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<!-- Files Section -->\n\t\t<div class=\"card bg-base-100 shadow-xl\">\n\t\t\t<div class=\"card-body\">\n\t\t\t\t<div class=\"flex justify-between items-center mb-4\">\n\t\t\t\t\t<h2 class=\"card-title text-2xl\">Uploaded Files</h2>\n\t\t\t\t\t<button class=\"btn btn-outline btn-sm\" id=\"refreshBtn\">\n\t\t\t\t\t\t<span class=\"loading loading-spinner loading-sm hidden\" id=\"refreshSpinner\"></span>\n\t\t\t\t\t\tRefresh\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div id=\"filesList\" class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n\t\t\t\t\t<!-- Files will be loaded here -->\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div id=\"loadingFiles\" class=\"text-center py-8\">\n\t\t\t\t\t<span class=\"loading loading-spinner loading-lg\"></span>\n\t\t\t\t\t<p class=\"mt-2\">Loading files...</p>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div id=\"noFiles\" class=\"text-center py-8 hidden\">\n\t\t\t\t\t<div class=\"text-6xl mb-4\">üìÅ</div>\n\t\t\t\t\t<p class=\"text-lg\">No files uploaded yet</p>\n\t\t\t\t\t<p class=\"text-sm text-base-content/70\">Upload some files to get started</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</Layout>\n\n<script>\n\tconst assetsPrefix = '${assetsPrefix}';\n\t\n\t// DOM elements\n\tconst uploadForm = document.getElementById('uploadForm') as HTMLFormElement;\n\tconst fileInput = document.getElementById('fileInput') as HTMLInputElement;\n\tconst uploadBtn = document.getElementById('uploadBtn') as HTMLButtonElement;\n\tconst uploadSpinner = document.getElementById('uploadSpinner') as HTMLElement;\n\tconst uploadProgress = document.getElementById('uploadProgress') as HTMLElement;\n\tconst progressBar = document.getElementById('progressBar') as HTMLElement;\n\tconst progressText = document.getElementById('progressText') as HTMLElement;\n\tconst filesList = document.getElementById('filesList') as HTMLElement;\n\tconst loadingFiles = document.getElementById('loadingFiles') as HTMLElement;\n\tconst noFiles = document.getElementById('noFiles') as HTMLElement;\n\tconst refreshBtn = document.getElementById('refreshBtn') as HTMLButtonElement;\n\tconst refreshSpinner = document.getElementById('refreshSpinner') as HTMLElement;\n\n\t// File type icons mapping\n\tconst fileIcons: Record<string, string> = {\n\t\t'pdf': 'üìÑ',\n\t\t'doc': 'üìù',\n\t\t'docx': 'üìù',\n\t\t'txt': 'üìÑ',\n\t\t'zip': 'üì¶',\n\t\t'rar': 'üì¶',\n\t\t'video': 'üé•',\n\t\t'audio': 'üéµ',\n\t\t'default': 'üìé'\n\t};\n\n\t// Get file icon based on type\n\tfunction getFileIcon(filename: string): string {\n\t\tconst ext = filename.split('.').pop()?.toLowerCase();\n\t\tif (ext && fileIcons[ext]) {\n\t\t\treturn fileIcons[ext];\n\t\t}\n\t\t\n\t\t// Check if it's a video or audio file\n\t\tif (filename.match(/\\.(mp4|avi|mov|wmv|flv|webm|mkv)$/i)) {\n\t\t\treturn fileIcons.video;\n\t\t}\n\t\tif (filename.match(/\\.(mp3|wav|flac|aac|ogg|wma)$/i)) {\n\t\t\treturn fileIcons.audio;\n\t\t}\n\t\t\n\t\treturn fileIcons.default;\n\t}\n\n\t// Format file size\n\tfunction formatFileSize(bytes: number): string {\n\t\tif (bytes === 0) return '0 Bytes';\n\t\tconst k = 1024;\n\t\tconst sizes = ['Bytes', 'KB', 'MB', 'GB'];\n\t\tconst i = Math.floor(Math.log(bytes) / Math.log(k));\n\t\treturn parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n\t}\n\n\t// Format date\n\tfunction formatDate(dateString: string): string {\n\t\treturn new Date(dateString).toLocaleDateString('en-US', {\n\t\t\tyear: 'numeric',\n\t\t\tmonth: 'short',\n\t\t\tday: 'numeric',\n\t\t\thour: '2-digit',\n\t\t\tminute: '2-digit'\n\t\t});\n\t}\n\n\t// Check if file is an image\n\tfunction isImage(filename: string): boolean {\n\t\treturn filename.match(/\\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i) !== null;\n\t}\n\n\t// File interface\n\tinterface FileItem {\n\t\tname?: string;\n\t\tlink?: string;\n\t\tdateUploaded?: string;\n\t\tkey?: string;\n\t\tuploaded?: string;\n\t\tsize?: number;\n\t\thttpMetadata?: {\n\t\t\tcontentType?: string;\n\t\t};\n\t}\n\n\tasync function deleteFile(key: string | undefined, displayName: string, triggerBtn?: HTMLButtonElement) {\n\t\tif (!key) {\n\t\t\talert('Unable to delete this file because it is missing a key.');\n\t\t\treturn;\n\t\t}\n\n\t\tconst confirmed = window.confirm(`Delete \"${displayName}\"? This action cannot be undone.`);\n\t\tif (!confirmed) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet originalContent: string | null = null;\n\t\tif (triggerBtn) {\n\t\t\toriginalContent = triggerBtn.innerHTML;\n\t\t\ttriggerBtn.disabled = true;\n\t\t\ttriggerBtn.innerHTML = '<span class=\"loading loading-spinner loading-xs\"></span> Deleting...';\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await fetch(`${assetsPrefix}/api/delete-asset`, {\n\t\t\t\tmethod: 'DELETE',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t},\n\t\t\t\tbody: JSON.stringify({ key })\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconst message = await response.text();\n\t\t\t\tthrow new Error(message || 'Failed to delete file');\n\t\t\t}\n\n\t\t\tawait loadFiles();\n\t\t} catch (error) {\n\t\t\tconsole.error('Error deleting file:', error);\n\t\t\talert('Failed to delete file. Please try again.');\n\t\t} finally {\n\t\t\tif (triggerBtn) {\n\t\t\t\ttriggerBtn.disabled = false;\n\t\t\t\ttriggerBtn.innerHTML = originalContent || 'Delete';\n\t\t\t}\n\t\t}\n\t}\n\n\t// Load and display files\n\tasync function loadFiles() {\n\t\ttry {\n\t\t\tloadingFiles.classList.remove('hidden');\n\t\t\tfilesList.innerHTML = '';\n\t\t\t\n\t\t\tconst response = await fetch(`${assetsPrefix}/api/list-assets`);\n\t\t\tif (!response.ok) {\n\t\t\t\tthrow new Error('Failed to load files');\n\t\t\t}\n\t\t\t\n\t\t\tconst files = await response.json() as FileItem[];\n\t\t\t\n\t\t\tloadingFiles.classList.add('hidden');\n\t\t\t\n\t\t\tif (files.length === 0) {\n\t\t\t\tnoFiles.classList.remove('hidden');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tnoFiles.classList.add('hidden');\n\t\t\t\n\t\t\tfiles.forEach((file: FileItem) => {\n\t\t\t\tconst fileKey = file.key;\n\t\t\t\tconst displayName = file.name || fileKey || 'Unnamed file';\n\t\t\t\tconst fileLink = file.link || (fileKey ? `${assetsPrefix}/api/asset?key=${encodeURIComponent(fileKey)}` : '#');\n\t\t\t\tconst uploadedAt = file.dateUploaded || file.uploaded || new Date().toISOString();\n\n\t\t\t\tconst fileCard = document.createElement('div');\n\t\t\t\tfileCard.className = 'card bg-base-200 shadow-sm hover:shadow-md transition-shadow';\n\t\t\t\t\n\t\t\t\tconst isImageFile = displayName ? isImage(displayName) : false;\n\t\t\t\t\n\t\t\t\tfileCard.innerHTML = `\n\t\t\t\t\t<figure class=\"px-4 pt-4\">\n\t\t\t\t\t\t${isImageFile \n\t\t\t\t\t\t\t? `<img src=\"${fileLink}\" alt=\"${displayName}\" class=\"rounded-xl h-32 w-full object-cover\" />`\n\t\t\t\t\t\t\t: `<div class=\"flex items-center justify-center h-32 w-full bg-base-300 rounded-xl\">\n\t\t\t\t\t\t\t\t<span class=\"text-4xl\">${getFileIcon(displayName)}</span>\n\t\t\t\t\t   </div>`\n\t\t\t\t\t\t}\n\t\t\t\t\t</figure>\n\t\t\t\t\t<div class=\"card-body p-4\">\n\t\t\t\t\t\t<h3 class=\"card-title text-sm truncate\" title=\"${displayName}\">${displayName}</h3>\n\t\t\t\t\t\t<p class=\"text-xs text-base-content/70\">${formatDate(uploadedAt)}</p>\n\t\t\t\t\t\t<div class=\"card-actions justify-end mt-2\">\n\t\t\t\t\t\t\t<a href=\"${fileLink}\" target=\"_blank\" class=\"btn btn-primary btn-xs\">\n\t\t\t\t\t\t\t\tView\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t<button class=\"btn btn-error btn-outline btn-xs\" data-role=\"delete-btn\" ${fileKey ? '' : 'disabled'}>\n\t\t\t\t\t\t\t\tDelete\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`;\n\n\t\t\t\tconst deleteBtn = fileCard.querySelector('[data-role=\"delete-btn\"]') as HTMLButtonElement | null;\n\t\t\t\tif (deleteBtn) {\n\t\t\t\t\tdeleteBtn.addEventListener('click', () => deleteFile(fileKey, displayName, deleteBtn));\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfilesList.appendChild(fileCard);\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tconsole.error('Error loading files:', error);\n\t\t\tloadingFiles.classList.add('hidden');\n\t\t\tfilesList.innerHTML = `\n\t\t\t\t<div class=\"col-span-full text-center py-8\">\n\t\t\t\t\t<div class=\"text-6xl mb-4\">‚ùå</div>\n\t\t\t\t\t<p class=\"text-lg text-error\">Failed to load files</p>\n\t\t\t\t\t<p class=\"text-sm text-base-content/70\">Please try again later</p>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}\n\t}\n\n\t// Handle file upload\n\tasync function handleUpload(event: Event) {\n\t\tevent.preventDefault();\n\t\t\n\t\tconst files = fileInput.files;\n\t\tif (!files || files.length === 0) {\n\t\t\talert('Please select files to upload');\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t// Show loading state\n\t\tuploadBtn.disabled = true;\n\t\tuploadSpinner.classList.remove('hidden');\n\t\tuploadProgress.classList.remove('hidden');\n\t\t\n\t\ttry {\n\t\t\tfor (let i = 0; i < files.length; i++) {\n\t\t\t\tconst file = files[i];\n\t\t\t\tconst formData = new FormData();\n\t\t\t\tformData.append('file', file);\n\t\t\t\t\n\t\t\t\t// Update progress\n\t\t\t\tconst progress = ((i + 1) / files.length) * 100;\n\t\t\t\tprogressBar.style.width = `${progress}%`;\n\t\t\t\tprogressText.textContent = `Uploading ${file.name}...`;\n\t\t\t\t\n\t\t\t\tconst response = await fetch(`${assetsPrefix}/api/upload`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tbody: formData\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tif (!response.ok) {\n\t\t\t\t\tthrow new Error(`Failed to upload ${file.name}`);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// Success\n\t\t\tprogressText.textContent = 'Upload completed!';\n\t\t\tprogressBar.style.width = '100%';\n\t\t\t\n\t\t\t// Reset form\n\t\t\tfileInput.value = '';\n\t\t\t\n\t\t\t// Reload files list\n\t\t\tsetTimeout(() => {\n\t\t\t\tloadFiles();\n\t\t\t\tuploadProgress.classList.add('hidden');\n\t\t\t}, 1000);\n\t\t\t\n\t\t} catch (error) {\n\t\t\tconsole.error('Upload error:', error);\n\t\t\tprogressText.textContent = 'Upload failed!';\n\t\t\talert('Upload failed: ' + (error instanceof Error ? error.message : 'Unknown error'));\n\t\t} finally {\n\t\t\t// Reset loading state\n\t\t\tuploadBtn.disabled = false;\n\t\t\tuploadSpinner.classList.add('hidden');\n\t\t}\n\t}\n\n\t// Event listeners\n\tuploadForm.addEventListener('submit', handleUpload);\n\trefreshBtn.addEventListener('click', () => {\n\t\trefreshSpinner.classList.remove('hidden');\n\t\tloadFiles().finally(() => {\n\t\t\trefreshSpinner.classList.add('hidden');\n\t\t});\n\t});\n\n\t// Load files on page load\n\tloadFiles();\n</script>\n"
        }
    ]
}