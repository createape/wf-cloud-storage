{
    "sourceFile": "src/pages/api/auth/login.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764456537324,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764456537324,
            "name": "Commit-0",
            "content": "import type { APIRoute } from 'astro'\r\nimport { createGoogleProvider, generateState, generateCodeVerifier } from '../../../lib/auth/arctic'\r\nimport { AUTH_CONFIG } from '../../../lib/auth/config'\r\n\r\nexport const GET: APIRoute = async ({ cookies, redirect, locals }) => {\r\n    const env = locals.runtime.env\r\n\r\n    // Get Google credentials from environment\r\n    const clientId = env.GOOGLE_CLIENT_ID\r\n    const clientSecret = env.GOOGLE_CLIENT_SECRET\r\n    const origin = env.ORIGIN\r\n\r\n    if (!clientId || !clientSecret || !origin) {\r\n        return new Response(\r\n            JSON.stringify({ error: 'Missing OAuth configuration' }),\r\n            { status: 500, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n    }\r\n\r\n    // Create Google provider\r\n    const google = createGoogleProvider(clientId, clientSecret, origin)\r\n\r\n    // Generate state and code verifier for PKCE\r\n    const state = generateState()\r\n    const codeVerifier = generateCodeVerifier()\r\n\r\n    // Create authorization URL with PKCE\r\n    const url = google.createAuthorizationURL(state, codeVerifier, AUTH_CONFIG.GOOGLE_SCOPES)\r\n\r\n    // Request refresh token for long-lived sessions\r\n    url.searchParams.set('access_type', 'offline')\r\n    url.searchParams.set('prompt', 'consent')\r\n\r\n    // Store state and code verifier in cookies for callback verification\r\n    cookies.set(AUTH_CONFIG.STATE_COOKIE, state, AUTH_CONFIG.OAUTH_COOKIE_OPTIONS)\r\n    cookies.set(AUTH_CONFIG.CODE_VERIFIER_COOKIE, codeVerifier, AUTH_CONFIG.OAUTH_COOKIE_OPTIONS)\r\n\r\n    // Redirect to Google OAuth\r\n    return redirect(url.toString())\r\n}\r\n"
        }
    ]
}