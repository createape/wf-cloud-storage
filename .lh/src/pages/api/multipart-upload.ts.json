{
    "sourceFile": "src/pages/api/multipart-upload.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764443175327,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764443175327,
            "name": "Commit-0",
            "content": "import type { APIRoute } from \"astro\";\nimport { API } from \"../../utils/api\";\nimport { requireAuth } from \"../../lib/auth-guard\";\n\ninterface MultipartUploadRequest {\n  key: string;\n  contentType?: string;\n}\n\ninterface CompleteMultipartRequest {\n  uploadId: string;\n  key: string;\n  parts: R2UploadedPart[];\n}\n\n// Helper function to parse JSON\nasync function parseRequestData(\n  request: Request\n): Promise<{ [key: string]: any }> {\n  const contentType = request.headers.get(\"content-type\") || \"\";\n\n  if (contentType.includes(\"application/json\")) {\n    return await request.json();\n  }\n\n  throw new Error(\"Content-Type must be application/json\");\n}\n\n// Creates and completes a new multipart upload session\nexport const POST: APIRoute = async (context) => {\n  const { request, locals } = context;\n  \n  // Set the origin for the API\n  API.init((locals.runtime as any).env.ORIGIN);\n\n  // Auth check\n  const authError = await requireAuth(context);\n  if (authError) return authError;\n\n  // Handle CORS preflight requests\n  if (request.method === \"OPTIONS\") {\n    console.log(\"CORS preflight request from:\", request.headers.get(\"Origin\"));\n    return API.cors(request);\n  }\n\n  try {\n    // Check if bucket is available\n    const bucket = locals.runtime.env.CLOUD_FILES;\n    if (!bucket) {\n      return API.error(\"Cloud storage not configured\", request, 500);\n    }\n\n    const url = new URL(request.url);\n    const action = url.searchParams.get(\"action\");\n\n    if (!action) {\n      return API.error(\"Missing action parameter\", request, 400);\n    }\n\n    switch (action) {\n      case \"create\": {\n        // Create a new multipart upload\n        const parsedData = await parseRequestData(request);\n        const body: MultipartUploadRequest = {\n          key: parsedData.key as string,\n          contentType: parsedData.contentType as string | undefined,\n        };\n\n        if (!body.key) {\n          return API.error(\"Missing key parameter\", request, 400);\n        }\n\n        try {\n          const multipartUpload = await bucket.createMultipartUpload(body.key, {\n            httpMetadata: body.contentType\n              ? {\n                  contentType: body.contentType,\n                }\n              : undefined,\n          });\n\n          return API.success(\n            {\n              success: true,\n              key: multipartUpload.key,\n              uploadId: multipartUpload.uploadId,\n            },\n            request\n          );\n        } catch (error) {\n          console.error(\"Failed to create multipart upload:\", error);\n          return API.error(\"Failed to create multipart upload\", request, 500);\n        }\n      }\n\n      case \"complete\": {\n        // Complete a multipart upload\n        const parsedData = await parseRequestData(request);\n        const body: CompleteMultipartRequest = {\n          uploadId: parsedData.uploadId as string,\n          key: parsedData.key as string,\n          parts: parsedData.parts as R2UploadedPart[],\n        };\n\n        if (!body.uploadId || !body.key || !body.parts) {\n          return API.error(\"Missing required parameters\", request, 400);\n        }\n\n        try {\n          const multipartUpload = bucket.resumeMultipartUpload(\n            body.key,\n            body.uploadId\n          );\n\n          // Parts are already in R2UploadedPart format\n          const r2Parts = body.parts;\n\n          const object = await multipartUpload.complete(r2Parts);\n\n          return API.success(\n            {\n              success: true,\n              key: object.key,\n              etag: object.httpEtag,\n              size: object.size,\n            },\n            request\n          );\n        } catch (error: any) {\n          console.error(\"Failed to complete multipart upload:\", error);\n          return API.error(\n            error.message || \"Failed to complete multipart upload\",\n            request,\n            400\n          );\n        }\n      }\n\n      default:\n        return API.error(`Unknown action: ${action}`, request, 400);\n    }\n  } catch (error) {\n    console.error(\"Multipart upload error:\", error);\n    return API.error(\"Multipart upload failed\", request, 500);\n  }\n};\n\n// Uploads individual parts of a multipart upload\nexport const PUT: APIRoute = async (context) => {\n  const { request, locals } = context;\n  \n  // Set the origin for the API\n  API.init((locals.runtime as any).env.ORIGIN);\n\n  // Auth check\n  const authError = await requireAuth(context);\n  if (authError) return authError;\n\n  // Handle CORS preflight requests\n  if (request.method === \"OPTIONS\") {\n    console.log(\"CORS preflight request from:\", request.headers.get(\"Origin\"));\n    return API.cors(request);\n  }\n\n  try {\n    // Check if bucket is available\n    const bucket = locals.runtime.env.CLOUD_FILES;\n    if (!bucket) {\n      return API.error(\"Cloud storage not configured\", request, 500);\n    }\n\n    const url = new URL(request.url);\n    const action = url.searchParams.get(\"action\");\n\n    if (action !== \"upload-part\") {\n      return API.error(`Unknown action: ${action}`, request, 400);\n    }\n\n    const uploadId = url.searchParams.get(\"uploadId\");\n    const partNumberStr = url.searchParams.get(\"partNumber\");\n    const key = url.searchParams.get(\"key\");\n\n    if (!uploadId || !partNumberStr || !key) {\n      return API.error(\"Missing uploadId, partNumber, or key\", request, 400);\n    }\n\n    const partNumber = parseInt(partNumberStr);\n    if (isNaN(partNumber) || partNumber < 1) {\n      return API.error(\"Invalid part number\", request, 400);\n    }\n\n    if (!request.body) {\n      return API.error(\"Missing request body\", request, 400);\n    }\n\n    try {\n      const multipartUpload = bucket.resumeMultipartUpload(key, uploadId);\n\n      // Convert request body to ArrayBuffer to get known length\n      const arrayBuffer = await request.arrayBuffer();\n      const uploadedPart = await multipartUpload.uploadPart(\n        partNumber,\n        arrayBuffer\n      );\n\n      return API.success(\n        {\n          success: true,\n          partNumber: uploadedPart.partNumber,\n          etag: uploadedPart.etag,\n        },\n        request\n      );\n    } catch (error: any) {\n      console.error(\"Failed to upload part:\", error);\n      return API.error(error.message || \"Failed to upload part\", request, 400);\n    }\n  } catch (error) {\n    console.error(\"Upload part error:\", error);\n    return API.error(\"Upload part failed\", request, 500);\n  }\n};\n\n// Aborts a multipart upload\nexport const DELETE: APIRoute = async (context) => {\n  const { request, locals } = context;\n  \n  // Set the origin for the API\n  API.init((locals.runtime as any).env.ORIGIN);\n\n  // Auth check\n  const authError = await requireAuth(context);\n  if (authError) return authError;\n\n  // Handle CORS preflight requests\n  if (request.method === \"OPTIONS\") {\n    console.log(\"CORS preflight request from:\", request.headers.get(\"Origin\"));\n    return API.cors(request);\n  }\n\n  try {\n    // Check if bucket is available\n    const bucket = locals.runtime.env.CLOUD_FILES;\n    if (!bucket) {\n      return API.error(\"Cloud storage not configured\", request, 500);\n    }\n\n    const url = new URL(request.url);\n    const action = url.searchParams.get(\"action\");\n\n    if (action !== \"abort\") {\n      return API.error(`Unknown action: ${action}`, request, 400);\n    }\n\n    const uploadId = url.searchParams.get(\"uploadId\");\n    const key = url.searchParams.get(\"key\");\n\n    if (!uploadId || !key) {\n      return API.error(\"Missing uploadId or key\", request, 400);\n    }\n\n    try {\n      const multipartUpload = bucket.resumeMultipartUpload(key, uploadId);\n      await multipartUpload.abort();\n\n      return API.success(\n        {\n          success: true,\n          message: \"Multipart upload aborted successfully\",\n        },\n        request\n      );\n    } catch (error: any) {\n      console.error(\"Failed to abort multipart upload:\", error);\n      return API.error(\n        error.message || \"Failed to abort multipart upload\",\n        request,\n        400\n      );\n    }\n  } catch (error) {\n    console.error(\"Abort multipart upload error:\", error);\n    return API.error(\"Abort multipart upload failed\", request, 500);\n  }\n};\n\nexport const OPTIONS: APIRoute = async ({ request, locals }) => {\n  // Set the origin for the API\n  API.init((locals.runtime as any).env.ORIGIN);\n  return API.cors(request);\n};\n"
        }
    ]
}