{
    "sourceFile": "src/middleware.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1764344487121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764354459873,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-import { auth } from \"./lib/auth\";\r\n+import { getAuth } from \"./lib/auth\";\r\n import { defineMiddleware } from \"astro:middleware\";\r\n \r\n // Base path from astro config\r\n const basePath = \"/ca\";\r\n@@ -8,51 +8,52 @@\n const protectedRoutes = [\"/\", \"/files\"];\r\n const protectedApiRoutes = [\"/api/upload\", \"/api/multipart-upload\", \"/api/list-assets\"];\r\n \r\n export const onRequest = defineMiddleware(async (context, next) => {\r\n-  // Get session from Better Auth\r\n-  const session = await auth.api.getSession({\r\n-    headers: context.request.headers,\r\n-  });\r\n+    const auth = getAuth(context.locals.runtime.env);\r\n+    // Get session from Better Auth\r\n+    const session = await auth.api.getSession({\r\n+        headers: context.request.headers,\r\n+    });\r\n \r\n-  if (session) {\r\n-    context.locals.user = session.user;\r\n-    context.locals.session = session.session;\r\n-  } else {\r\n-    context.locals.user = null;\r\n-    context.locals.session = null;\r\n-  }\r\n+    if (session) {\r\n+        context.locals.user = session.user;\r\n+        context.locals.session = session.session;\r\n+    } else {\r\n+        context.locals.user = null;\r\n+        context.locals.session = null;\r\n+    }\r\n \r\n-  const pathname = context.url.pathname;\r\n-  \r\n-  // Remove base path for route matching\r\n-  const pathWithoutBase = pathname.startsWith(basePath) \r\n-    ? pathname.slice(basePath.length) || \"/\"\r\n-    : pathname;\r\n+    const pathname = context.url.pathname;\r\n \r\n-  // Check if route is protected\r\n-  const isProtectedPage = protectedRoutes.some(\r\n-    (route) => pathWithoutBase === route || pathWithoutBase === route + \"/\"\r\n-  );\r\n+    // Remove base path for route matching\r\n+    const pathWithoutBase = pathname.startsWith(basePath)\r\n+        ? pathname.slice(basePath.length) || \"/\"\r\n+        : pathname;\r\n \r\n-  const isProtectedApi = protectedApiRoutes.some(\r\n-    (route) => pathWithoutBase.startsWith(route)\r\n-  );\r\n+    // Check if route is protected\r\n+    const isProtectedPage = protectedRoutes.some(\r\n+        (route) => pathWithoutBase === route || pathWithoutBase === route + \"/\"\r\n+    );\r\n \r\n-  // Redirect to login if accessing protected route without session\r\n-  if (isProtectedPage && !session) {\r\n-    return context.redirect(`${basePath}/login`);\r\n-  }\r\n-\r\n-  // Return 401 for protected API routes without session\r\n-  if (isProtectedApi && !session) {\r\n-    return new Response(\r\n-      JSON.stringify({ error: \"Unauthorized\" }),\r\n-      {\r\n-        status: 401,\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-      }\r\n+    const isProtectedApi = protectedApiRoutes.some(\r\n+        (route) => pathWithoutBase.startsWith(route)\r\n     );\r\n-  }\r\n \r\n-  return next();\r\n+    // Redirect to login if accessing protected route without session\r\n+    if (isProtectedPage && !session) {\r\n+        return context.redirect(`${basePath}/login`);\r\n+    }\r\n+\r\n+    // Return 401 for protected API routes without session\r\n+    if (isProtectedApi && !session) {\r\n+        return new Response(\r\n+            JSON.stringify({ error: \"Unauthorized\" }),\r\n+            {\r\n+                status: 401,\r\n+                headers: { \"Content-Type\": \"application/json\" },\r\n+            }\r\n+        );\r\n+    }\r\n+\r\n+    return next();\r\n });\r\n"
                },
                {
                    "date": 1764356747892,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-import { getAuth } from \"./lib/auth\";\r\n+import { getAuth, type AuthEnv } from \"./lib/auth\";\r\n import { defineMiddleware } from \"astro:middleware\";\r\n \r\n // Base path from astro config\r\n const basePath = \"/ca\";\r\n@@ -8,9 +8,20 @@\n const protectedRoutes = [\"/\", \"/files\"];\r\n const protectedApiRoutes = [\"/api/upload\", \"/api/multipart-upload\", \"/api/list-assets\"];\r\n \r\n export const onRequest = defineMiddleware(async (context, next) => {\r\n-    const auth = getAuth(context.locals.runtime.env);\r\n+    const runtimeEnv = context.locals.runtime.env;\r\n+    const authEnv: AuthEnv = {\r\n+        GOOGLE_CLIENT_ID: runtimeEnv.GOOGLE_CLIENT_ID,\r\n+        GOOGLE_CLIENT_SECRET: runtimeEnv.GOOGLE_CLIENT_SECRET,\r\n+        BETTER_AUTH_SECRET: runtimeEnv.BETTER_AUTH_SECRET,\r\n+        BETTER_AUTH_URL: runtimeEnv.BETTER_AUTH_URL,\r\n+        PUBLIC_BETTER_AUTH_URL: runtimeEnv.PUBLIC_BETTER_AUTH_URL,\r\n+        ORIGIN: runtimeEnv.ORIGIN,\r\n+        ORIGIN_DEV: runtimeEnv.ORIGIN_DEV,\r\n+    };\r\n+\r\n+    const auth = getAuth(authEnv);\r\n     // Get session from Better Auth\r\n     const session = await auth.api.getSession({\r\n         headers: context.request.headers,\r\n     });\r\n"
                }
            ],
            "date": 1764344487121,
            "name": "Commit-0",
            "content": "import { auth } from \"./lib/auth\";\r\nimport { defineMiddleware } from \"astro:middleware\";\r\n\r\n// Base path from astro config\r\nconst basePath = \"/ca\";\r\n\r\n// Protected routes that require authentication (relative to base)\r\nconst protectedRoutes = [\"/\", \"/files\"];\r\nconst protectedApiRoutes = [\"/api/upload\", \"/api/multipart-upload\", \"/api/list-assets\"];\r\n\r\nexport const onRequest = defineMiddleware(async (context, next) => {\r\n  // Get session from Better Auth\r\n  const session = await auth.api.getSession({\r\n    headers: context.request.headers,\r\n  });\r\n\r\n  if (session) {\r\n    context.locals.user = session.user;\r\n    context.locals.session = session.session;\r\n  } else {\r\n    context.locals.user = null;\r\n    context.locals.session = null;\r\n  }\r\n\r\n  const pathname = context.url.pathname;\r\n  \r\n  // Remove base path for route matching\r\n  const pathWithoutBase = pathname.startsWith(basePath) \r\n    ? pathname.slice(basePath.length) || \"/\"\r\n    : pathname;\r\n\r\n  // Check if route is protected\r\n  const isProtectedPage = protectedRoutes.some(\r\n    (route) => pathWithoutBase === route || pathWithoutBase === route + \"/\"\r\n  );\r\n\r\n  const isProtectedApi = protectedApiRoutes.some(\r\n    (route) => pathWithoutBase.startsWith(route)\r\n  );\r\n\r\n  // Redirect to login if accessing protected route without session\r\n  if (isProtectedPage && !session) {\r\n    return context.redirect(`${basePath}/login`);\r\n  }\r\n\r\n  // Return 401 for protected API routes without session\r\n  if (isProtectedApi && !session) {\r\n    return new Response(\r\n      JSON.stringify({ error: \"Unauthorized\" }),\r\n      {\r\n        status: 401,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      }\r\n    );\r\n  }\r\n\r\n  return next();\r\n});\r\n"
        }
    ]
}