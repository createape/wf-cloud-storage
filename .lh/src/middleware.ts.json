{
    "sourceFile": "src/middleware.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1764456537320,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764457365953,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,56 +2,62 @@\n import { verifySession } from './lib/auth/session'\r\n import { AUTH_CONFIG } from './lib/auth/config'\r\n \r\n export const onRequest = defineMiddleware(async (context, next) => {\r\n-  const { pathname } = context.url\r\n+    const { pathname } = context.url\r\n+    const { request } = context\r\n \r\n-  // Define public routes that don't require authentication\r\n-  const publicRoutes = [\r\n-    '/ca/api/asset',           // Asset serving (public files)\r\n-    '/ca/api/auth/',           // Auth endpoints (login, callback, logout)\r\n-    '/ca/login',               // Login page\r\n-  ]\r\n+    // Allow CORS preflight requests to pass through to endpoint handlers\r\n+    if (request.method === 'OPTIONS') {\r\n+        return next()\r\n+    }\r\n \r\n-  // Check if current route is public\r\n-  const isPublicRoute = publicRoutes.some(route => pathname.startsWith(route))\r\n+    // Define public routes that don't require authentication\r\n+    const publicRoutes = [\r\n+        '/ca/api/asset',           // Asset serving (public files)\r\n+        '/ca/api/auth/',           // Auth endpoints (login, callback, logout)\r\n+        '/ca/login',               // Login page\r\n+    ]\r\n \r\n-  if (isPublicRoute) {\r\n-    return next()\r\n-  }\r\n+    // Check if current route is public\r\n+    const isPublicRoute = publicRoutes.some(route => pathname.startsWith(route))\r\n \r\n-  // For protected routes, verify session\r\n-  if (pathname.startsWith('/ca/api/') || pathname.startsWith('/ca')) {\r\n-    const sessionCookie = context.cookies.get(AUTH_CONFIG.SESSION_COOKIE)?.value\r\n-    const authSecret = context.locals.runtime?.env?.AUTH_SECRET\r\n-\r\n-    if (!authSecret) {\r\n-      console.error('AUTH_SECRET not configured')\r\n-      if (pathname.startsWith('/ca/api/')) {\r\n-        return new Response(\r\n-          JSON.stringify({ error: 'Server configuration error' }),\r\n-          { status: 500, headers: { 'Content-Type': 'application/json' } }\r\n-        )\r\n-      }\r\n-      return context.redirect('/ca/login?error=auth_failed')\r\n+    if (isPublicRoute) {\r\n+        return next()\r\n     }\r\n \r\n-    const session = await verifySession(sessionCookie, authSecret)\r\n+    // For protected routes, verify session\r\n+    if (pathname.startsWith('/ca/api/') || pathname.startsWith('/ca')) {\r\n+        const sessionCookie = context.cookies.get(AUTH_CONFIG.SESSION_COOKIE)?.value\r\n+        const authSecret = context.locals.runtime?.env?.AUTH_SECRET\r\n \r\n-    if (!session) {\r\n-      // API routes return 401 Unauthorized\r\n-      if (pathname.startsWith('/ca/api/')) {\r\n-        return new Response(\r\n-          JSON.stringify({ error: 'Unauthorized' }),\r\n-          { status: 401, headers: { 'Content-Type': 'application/json' } }\r\n-        )\r\n-      }\r\n-      // Pages redirect to login\r\n-      return context.redirect('/ca/login?error=session_expired')\r\n+        if (!authSecret) {\r\n+            console.error('AUTH_SECRET not configured')\r\n+            if (pathname.startsWith('/ca/api/')) {\r\n+                return new Response(\r\n+                    JSON.stringify({ error: 'Server configuration error' }),\r\n+                    { status: 500, headers: { 'Content-Type': 'application/json' } }\r\n+                )\r\n+            }\r\n+            return context.redirect('/ca/login?error=auth_failed')\r\n+        }\r\n+\r\n+        const session = await verifySession(sessionCookie, authSecret)\r\n+\r\n+        if (!session) {\r\n+            // API routes return 401 Unauthorized\r\n+            if (pathname.startsWith('/ca/api/')) {\r\n+                return new Response(\r\n+                    JSON.stringify({ error: 'Unauthorized' }),\r\n+                    { status: 401, headers: { 'Content-Type': 'application/json' } }\r\n+                )\r\n+            }\r\n+            // Pages redirect to login\r\n+            return context.redirect('/ca/login?error=session_expired')\r\n+        }\r\n+\r\n+        // Attach session to locals for use in pages/endpoints\r\n+        context.locals.session = session\r\n     }\r\n \r\n-    // Attach session to locals for use in pages/endpoints\r\n-    context.locals.session = session\r\n-  }\r\n-\r\n-  return next()\r\n+    return next()\r\n })\r\n"
                }
            ],
            "date": 1764456537320,
            "name": "Commit-0",
            "content": "import { defineMiddleware } from 'astro:middleware'\r\nimport { verifySession } from './lib/auth/session'\r\nimport { AUTH_CONFIG } from './lib/auth/config'\r\n\r\nexport const onRequest = defineMiddleware(async (context, next) => {\r\n  const { pathname } = context.url\r\n\r\n  // Define public routes that don't require authentication\r\n  const publicRoutes = [\r\n    '/ca/api/asset',           // Asset serving (public files)\r\n    '/ca/api/auth/',           // Auth endpoints (login, callback, logout)\r\n    '/ca/login',               // Login page\r\n  ]\r\n\r\n  // Check if current route is public\r\n  const isPublicRoute = publicRoutes.some(route => pathname.startsWith(route))\r\n\r\n  if (isPublicRoute) {\r\n    return next()\r\n  }\r\n\r\n  // For protected routes, verify session\r\n  if (pathname.startsWith('/ca/api/') || pathname.startsWith('/ca')) {\r\n    const sessionCookie = context.cookies.get(AUTH_CONFIG.SESSION_COOKIE)?.value\r\n    const authSecret = context.locals.runtime?.env?.AUTH_SECRET\r\n\r\n    if (!authSecret) {\r\n      console.error('AUTH_SECRET not configured')\r\n      if (pathname.startsWith('/ca/api/')) {\r\n        return new Response(\r\n          JSON.stringify({ error: 'Server configuration error' }),\r\n          { status: 500, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n      }\r\n      return context.redirect('/ca/login?error=auth_failed')\r\n    }\r\n\r\n    const session = await verifySession(sessionCookie, authSecret)\r\n\r\n    if (!session) {\r\n      // API routes return 401 Unauthorized\r\n      if (pathname.startsWith('/ca/api/')) {\r\n        return new Response(\r\n          JSON.stringify({ error: 'Unauthorized' }),\r\n          { status: 401, headers: { 'Content-Type': 'application/json' } }\r\n        )\r\n      }\r\n      // Pages redirect to login\r\n      return context.redirect('/ca/login?error=session_expired')\r\n    }\r\n\r\n    // Attach session to locals for use in pages/endpoints\r\n    context.locals.session = session\r\n  }\r\n\r\n  return next()\r\n})\r\n"
        }
    ]
}